<div class="page-container">

    <!-- Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">Gestion des équipes</h1>
            <p class="page-subtitle">Affectez et suivez les membres de vos équipes projet</p>
        </div>
        <a routerLink="/chef-projet/matching" class="btn-primary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8" />
                <line x1="21" y1="21" x2="16.65" y2="16.65" />
            </svg>
            Trouver des profils (Matching)
        </a>
    </div>

    <!-- Toast -->
    @if (successMsg()) {
    <div class="toast success">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12" />
        </svg>
        {{ successMsg() }}
    </div>
    }

    <!-- Sélecteur projet -->
    <div class="selector-card">
        <div class="selector-row">
            <div class="selector-field">
                <label>Projet</label>
                <select [value]="selectedProjetId()" (change)="onProjetChange($any($event.target).value)">
                    <option value="">— Sélectionner un projet —</option>
                    @for (p of projets(); track p.id) {
                    <option [value]="p.id">{{ p.nom }}</option>
                    }
                </select>
            </div>
            @if (selectedProjet()) {
            <div class="project-meta">
                <span class="meta-tag statut-{{ selectedProjet()!.statut?.toLowerCase() }}">
                    {{ selectedProjet()!.statut }}
                </span>
                <span class="meta-tag">{{ membresActifs().length }} membres actifs</span>
                <span class="meta-tag charge">Charge totale: {{ totalAllocation() }}%</span>
            </div>
            }
        </div>
    </div>

    <!-- Membres de l'équipe -->
    @if (selectedProjetId()) {
    @if (loadingMembres()) {
    <div class="loading-state">
        <div class="spinner"></div>
        <span>Chargement de l'équipe...</span>
    </div>
    } @else if (membres().length === 0) {
    <div class="empty-state">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
            <circle cx="9" cy="7" r="4" />
            <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
        </svg>
        <h3>Aucun membre dans l'équipe</h3>
        <p>Lancez un matching pour trouver des profils compatibles</p>
        <a [routerLink]="['/chef-projet/matching']" [queryParams]="{projetId: selectedProjetId()}" class="btn-primary">
            Lancer le matching
        </a>
    </div>
    } @else {
    <!-- Résumé charge -->
    <div class="charge-overview">
        <div class="charge-item" [class]="'c-' + getChargeClass(totalAllocation() / (membres().length || 1))">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
            </svg>
            <span>Charge moyenne: <strong>{{ (totalAllocation() / (membres().length || 1)) | number:'1.0-0'
                    }}%</strong></span>
        </div>
        @if (totalAllocation() / (membres().length || 1) < 50) { <div class="alert-under">
            ⚠️ Équipe sous-staffée — Envisagez d'ajouter des membres
    </div>
    }
</div>

<!-- Grille des membres -->
<div class="team-grid">
    @for (membre of membres(); track membre.id) {
    <div class="membre-card" [class.inactive]="membre.statut !== 'ACTIVE'">

        <div class="membre-header">
            <div class="avatar" [style.background]="getAvatarColor(membre.employeNom)">
                {{ getInitials(membre.employePrenom, membre.employeNom) }}
            </div>
            <div class="membre-info">
                <div class="membre-name">{{ membre.employePrenom }} {{ membre.employeNom }}</div>
                <div class="membre-email">{{ membre.employeEmail }}</div>
            </div>
            <div class="membre-status" [class]="membre.statut === 'ACTIVE' ? 'active' : 'inactive'">
                {{ membre.statut === 'ACTIVE' ? 'Actif' : membre.statut }}
            </div>
        </div>

        <div class="membre-role">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3" />
                <path
                    d="M12 2v2m0 16v2m10-10h-2M4 12H2m15.07-8.07-1.41 1.41M9.34 15.66l-1.41 1.41m10.58 1.41-1.41-1.41M9.34 8.34 7.93 6.93" />
            </svg>
            {{ membre.roleDansProjet || 'Rôle non défini' }}
        </div>

        <div class="charge-section">
            <div class="charge-header">
                <span>Taux d'allocation</span>
                <span class="charge-value {{ getChargeClass(membre.tauxAllocation) }}">
                    {{ membre.tauxAllocation }}%
                </span>
            </div>
            <div class="charge-bar">
                <div class="charge-fill {{ getChargeClass(membre.tauxAllocation) }}"
                    [style.width.%]="membre.tauxAllocation"></div>
            </div>
            <div class="charge-label">{{ getChargeLabel(membre.tauxAllocation) }}</div>
        </div>

        <div class="membre-footer">
            <div class="membre-dates">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" />
                    <line x1="16" y1="2" x2="16" y2="6" />
                    <line x1="8" y1="2" x2="8" y2="6" />
                    <line x1="3" y1="10" x2="21" y2="10" />
                </svg>
                Depuis {{ membre.dateDebut | date:'dd/MM/yyyy' }}
            </div>
            @if (membre.scoreCompatibilite) {
            <div class="compat-score" [class]="getScoreClass(membre.scoreCompatibilite)">
                ⚡ {{ membre.scoreCompatibilite }}%
            </div>
            }
        </div>

        <div class="membre-actions">
            <a [routerLink]="['/chef-projet/matching']" [queryParams]="{ projetId: selectedProjetId() }"
                class="btn-action info" title="Voir profil matching">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8" />
                    <line x1="21" y1="21" x2="16.65" y2="16.65" />
                </svg>
            </a>
            <button class="btn-action danger" (click)="retirer(membre)" title="Retirer du projet">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18" />
                    <line x1="6" y1="6" x2="18" y2="18" />
                </svg>
            </button>
        </div>
    </div>
    }
</div>
}
} @else {
<div class="initial-state">
    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
        <circle cx="9" cy="7" r="4" />
        <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
    </svg>
    <h3>Sélectionnez un projet</h3>
    <p>Choisissez un projet pour voir et gérer son équipe</p>
</div>
}
</div>