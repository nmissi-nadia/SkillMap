<div class="page-container">

    <!-- Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">Gestion des projets</h1>
            <p class="page-subtitle">Créez, suivez et pilotez vos projets internes</p>
        </div>
        <button class="btn-primary" (click)="openCreate()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19" />
                <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
            Nouveau projet
        </button>
    </div>

    <!-- Error Banner -->
    @if (error()) {
    <div class="error-banner">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" />
            <line x1="12" y1="8" x2="12" y2="12" />
            <line x1="12" y1="16" x2="12.01" y2="16" />
        </svg>
        <span>{{ error() }}</span>
        <button class="close-error" (click)="error.set(null)">×</button>
    </div>
    }

    <!-- Filtres -->
    <div class="filters-bar">
        <div class="search-box">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8" />
                <line x1="21" y1="21" x2="16.65" y2="16.65" />
            </svg>
            <input type="text" placeholder="Rechercher un projet..." [value]="filtreRecherche()"
                (input)="filtreRecherche.set($any($event.target).value)">
        </div>
        <select [value]="filtreStatut()" (change)="filtreStatut.set($any($event.target).value)">
            <option value="">Tous les statuts</option>
            <option value="PLANIFIE">Planifié</option>
            <option value="EN_COURS">En cours</option>
            <option value="TERMINE">Terminé</option>
            <option value="SUSPENDU">Suspendu</option>
        </select>
        <select [value]="filtrePriorite()" (change)="filtrePriorite.set($any($event.target).value)">
            <option value="">Toutes les priorités</option>
            <option value="HAUTE">Haute</option>
            <option value="MOYENNE">Moyenne</option>
            <option value="BASSE">Basse</option>
        </select>
        <span class="results-count">{{ projetsFiltres().length }} projet(s)</span>
    </div>

    <!-- Loading -->
    @if (loading()) {
    <div class="loading-state">
        <div class="spinner"></div>
        <span>Chargement des projets...</span>
    </div>
    }

    <!-- Table des projets -->
    @if (!loading()) {
    @if (projetsFiltres().length === 0) {
    <div class="empty-state">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <rect x="2" y="3" width="20" height="14" rx="2" />
            <line x1="8" y1="21" x2="16" y2="21" />
            <line x1="12" y1="17" x2="12" y2="21" />
        </svg>
        <h3>Aucun projet trouvé</h3>
        <p>Créez votre premier projet pour commencer</p>
        <button class="btn-primary" (click)="openCreate()">Créer un projet</button>
    </div>
    } @else {
    <div class="table-card">
        <table class="projects-table">
            <thead>
                <tr>
                    <th>Projet</th>
                    <th>Client</th>
                    <th>Statut</th>
                    <th>Priorité</th>
                    <th>Dates</th>
                    <th>Progression</th>
                    <th>Budget</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @for (projet of projetsFiltres(); track projet.id) {
                <tr class="table-row">
                    <td>
                        <div class="project-name-cell">
                            <span class="project-name">{{ projet.nom }}</span>
                            <span class="project-desc">{{ projet.description }}</span>
                        </div>
                    </td>
                    <td><span class="client-chip">{{ projet.client || '—' }}</span></td>
                    <td>
                        <span class="badge statut-{{ projet.statut.toLowerCase() }}">
                            {{ getStatutLabel(projet.statut) }}
                        </span>
                    </td>
                    <td>
                        <span class="priorite-badge p-{{ projet.priorite.toLowerCase() }}">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor">
                                <circle cx="12" cy="12" r="10" />
                            </svg>
                            {{ projet.priorite }}
                        </span>
                    </td>
                    <td>
                        <div class="dates-cell">
                            <span>{{ projet.dateDebut | date:'dd/MM/yy' }}</span>
                            <span class="date-arrow">→</span>
                            <span>{{ projet.dateFin | date:'dd/MM/yy' }}</span>
                        </div>
                    </td>
                    <td>
                        <div class="progress-cell">
                            <div class="progress-bar">
                                <div class="progress-fill" [class.high]="projet.progression >= 75"
                                    [class.medium]="projet.progression >= 40 && projet.progression < 75"
                                    [class.low]="projet.progression < 40" [style.width.%]="projet.progression"></div>
                            </div>
                            <span class="progress-pct">{{ projet.progression }}%</span>
                        </div>
                    </td>
                    <td>
                        <span class="budget-text">
                            {{ projet.budget | number:'1.0-0' }} €
                        </span>
                    </td>
                    <td>
                        <div class="actions-cell">
                            <a [routerLink]="['/chef-projet/matching']" [queryParams]="{ projetId: projet.id }"
                                class="action-btn matching" title="Lancer matching">
                                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <circle cx="11" cy="11" r="8" />
                                    <line x1="21" y1="21" x2="16.65" y2="16.65" />
                                </svg>
                            </a>
                            <a [routerLink]="['/chef-projet/equipe']" [queryParams]="{ projetId: projet.id }"
                                class="action-btn equipe" title="Gérer l'équipe">
                                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                                    <circle cx="9" cy="7" r="4" />
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                                </svg>
                            </a>
                            <a [routerLink]="['/chef-projet/messagerie']" [queryParams]="{ projetId: projet.id }"
                                class="action-btn messages" title="Messagerie projet">
                                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                                </svg>
                            </a>
                            <button class="action-btn edit" (click)="openEdit(projet)" title="Modifier">
                                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                                </svg>
                            </button>
                            <button class="action-btn delete" (click)="delete(projet.id)" title="Supprimer">
                                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <polyline points="3 6 5 6 21 6" />
                                    <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" />
                                    <path d="M10 11v6" />
                                    <path d="M14 11v6" />
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
                }
            </tbody>
        </table>
    </div>
    }
    }

    <!-- Modal Création / Édition -->
    @if (showModal()) {
    <div class="modal-overlay" (click)="closeModal()">
        <div class="modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h2>{{ isEditing() ? 'Modifier le projet' : 'Nouveau projet' }}</h2>
                <button class="modal-close" (click)="closeModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group full">
                        <label>Nom du projet *</label>
                        <input type="text" [value]="projetEnCours().nom ?? ''"
                            (input)="updateField('nom', $any($event.target).value)"
                            placeholder="Ex: Refonte Portail Client">
                    </div>
                    <div class="form-group full">
                        <label>Description</label>
                        <textarea [value]="projetEnCours().description ?? ''"
                            (input)="updateField('description', $any($event.target).value)" rows="3"
                            placeholder="Décrivez les objectifs du projet"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Client</label>
                        <input type="text" [value]="projetEnCours().client ?? ''"
                            (input)="updateField('client', $any($event.target).value)" placeholder="Nom du client">
                    </div>
                    <div class="form-group">
                        <label>Budget (€)</label>
                        <input type="number" [value]="projetEnCours().budget ?? 0"
                            (input)="updateField('budget', +$any($event.target).value)">
                    </div>
                    <div class="form-group">
                        <label>Date début *</label>
                        <input type="date" [value]="projetEnCours().dateDebut ?? ''"
                            (change)="updateField('dateDebut', $any($event.target).value)">
                    </div>
                    <div class="form-group">
                        <label>Date fin *</label>
                        <input type="date" [value]="projetEnCours().dateFin ?? ''"
                            (change)="updateField('dateFin', $any($event.target).value)">
                    </div>
                    <div class="form-group">
                        <label>Priorité</label>
                        <select [value]="projetEnCours().priorite ?? 'MOYENNE'"
                            (change)="updateField('priorite', $any($event.target).value)">
                            <option value="HAUTE">Haute</option>
                            <option value="MOYENNE">Moyenne</option>
                            <option value="BASSE">Basse</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Statut</label>
                        <select [value]="projetEnCours().statut ?? 'PLANIFIE'"
                            (change)="updateField('statut', $any($event.target).value)">
                            <option value="PLANIFIE">Planifié</option>
                            <option value="EN_COURS">En cours</option>
                            <option value="TERMINE">Terminé</option>
                            <option value="SUSPENDU">Suspendu</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Charge estimée (j/h)</label>
                        <input type="number" [value]="projetEnCours().chargeEstimee ?? 0"
                            (input)="updateField('chargeEstimee', +$any($event.target).value)">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" (click)="closeModal()">Annuler</button>
                <button class="btn-primary" (click)="save()" [disabled]="saving()">
                    @if (saving()) { <div class="spinner-sm"></div> }
                    {{ isEditing() ? 'Enregistrer' : 'Créer le projet' }}
                </button>
            </div>
        </div>
    </div>
    }

</div>