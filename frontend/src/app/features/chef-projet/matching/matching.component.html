<div class="page-container">

    <!-- Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">Matching compétences ↔ projet</h1>
            <p class="page-subtitle">Trouvez les meilleurs profils pour vos projets</p>
        </div>
        <a routerLink="/chef-projet/projets" class="btn-secondary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="19" y1="12" x2="5" y2="12" />
                <polyline points="12 19 5 12 12 5" />
            </svg>
            Retour aux projets
        </a>
    </div>

    <!-- SUCCESS TOAST -->
    @if (affectationSuccess()) {
    <div class="toast success">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12" />
        </svg>
        {{ affectationSuccess() }}
    </div>
    }

    <!-- CONFIG PANEL -->
    <div class="config-panel">
        <div class="config-row">
            <div class="config-field">
                <label>Sélectionner un projet *</label>
                @if (loadingProjets()) {
                <div class="skeleton-select"></div>
                } @else {
                <select [value]="selectedProjetId()"
                    (change)="selectedProjetId.set($any($event.target).value); matchingDone.set(false)">
                    <option value="">— Choisir un projet —</option>
                    @for (p of projets(); track p.id) {
                    <option [value]="p.id">{{ p.nom }} ({{ p.statut }})</option>
                    }
                </select>
                }
            </div>
            <div class="config-field narrow">
                <label>Score minimum (%)</label>
                <input type="number" min="0" max="100" [value]="scoreMin()"
                    (input)="scoreMin.set(+$any($event.target).value)">
            </div>
            <button class="btn-matching" [disabled]="!selectedProjetId() || loadingMatching()"
                (click)="lancerMatching()">
                @if (loadingMatching()) {
                <div class="spinner-sm"></div>
                Analyse en cours...
                } @else {
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8" />
                    <line x1="21" y1="21" x2="16.65" y2="16.65" />
                </svg>
                Lancer le matching
                }
            </button>
        </div>
    </div>

    <!-- RÉSULTATS -->
    @if (matchingDone()) {
    <div class="results-header">
        <span class="results-count-badge">
            {{ candidatesTries().length }} profil(s) compatible(s) trouvé(s)
        </span>
        @if (selectedProjet()) {
        <span class="projet-tag">{{ selectedProjet()!.nom }}</span>
        }
    </div>

    @if (candidatesTries().length === 0) {
    <div class="empty-state">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <circle cx="11" cy="11" r="8" />
            <line x1="21" y1="21" x2="16.65" y2="16.65" />
        </svg>
        <h3>Aucun profil compatible</h3>
        <p>Essayez de baisser le score minimum ou de revoir les compétences requises</p>
    </div>
    } @else {
    <div class="candidates-layout">

        <!-- Liste des candidats -->
        <div class="candidates-list">
            @for (c of candidatesTries(); track c.employeId) {
            <div class="candidate-card" [class.selected]="selectedCandidate()?.employeId === c.employeId"
                [class.unavailable]="!c.disponible" (click)="selectCandidate(c)">

                <div class="candidate-top">
                    <div class="avatar">{{ c.prenom[0] }}{{ c.nom[0] }}</div>
                    <div class="candidate-info">
                        <div class="candidate-name">{{ c.prenom }} {{ c.nom }}</div>
                        <div class="candidate-poste">{{ c.poste }}</div>
                        <div class="candidate-dept">{{ c.departement }}</div>
                    </div>
                    <div class="score-circle {{ getScoreClass(c.scoreGlobal) }}">
                        <span class="score-value">{{ c.scoreGlobal }}</span>
                        <span class="score-pct">%</span>
                    </div>
                </div>

                <div class="candidate-bottom">
                    <div class="mini-scores">
                        <div class="mini-score">
                            <span class="mini-label">Compétences</span>
                            <div class="mini-bar">
                                <div class="mini-fill {{ getScoreClass(c.scoreCompetences) }}"
                                    [style.width.%]="c.scoreCompetences"></div>
                            </div>
                            <span class="mini-val">{{ c.scoreCompetences }}%</span>
                        </div>
                        <div class="mini-score">
                            <span class="mini-label">Disponibilité</span>
                            <div class="mini-bar">
                                <div class="mini-fill {{ getScoreClass(c.scoreDisponibilite) }}"
                                    [style.width.%]="c.scoreDisponibilite"></div>
                            </div>
                            <span class="mini-val">{{ c.scoreDisponibilite }}%</span>
                        </div>
                    </div>
                    <div class="candidate-tags">
                        @if (!c.disponible) {
                        <span class="tag unavail">Indisponible</span>
                        } @else {
                        <span class="tag avail">Disponible</span>
                        }
                        @if (c.competencesManquantes.length === 0) {
                        <span class="tag match">100% match</span>
                        }
                        <span class="tag label-{{ getScoreClass(c.scoreGlobal) }}">{{ getScoreLabel(c.scoreGlobal)
                            }}</span>
                    </div>
                </div>
            </div>
            }
        </div>

        <!-- Détail du candidat sélectionné -->
        @if (selectedCandidate()) {
        <div class="candidate-detail">
            <div class="detail-header">
                <div class="detail-avatar">{{ selectedCandidate()!.prenom[0] }}{{ selectedCandidate()!.nom[0] }}</div>
                <div>
                    <h2>{{ selectedCandidate()!.prenom }} {{ selectedCandidate()!.nom }}</h2>
                    <p>{{ selectedCandidate()!.poste }} · {{ selectedCandidate()!.departement }}</p>
                </div>
            </div>

            <div class="global-score-bar">
                <div class="gsb-label">Score global de compatibilité</div>
                <div class="gsb-bar">
                    <div class="gsb-fill {{ getScoreClass(selectedCandidate()!.scoreGlobal) }}"
                        [style.width.%]="selectedCandidate()!.scoreGlobal"></div>
                </div>
                <div class="gsb-value">{{ selectedCandidate()!.scoreGlobal }}% — {{
                    getScoreLabel(selectedCandidate()!.scoreGlobal) }}</div>
            </div>

            <div class="skills-section">
                <h3>Compétences correspondantes</h3>
                <div class="skills-grid">
                    @for (comp of selectedCandidate()!.competencesMatchees; track comp.competenceNom) {
                    <div class="skill-row" [class.ok]="comp.satisfait" [class.nok]="!comp.satisfait">
                        <div class="skill-name">
                            ({{ comp.satisfait ? 'OK' : 'KO' }}) {{ comp.competenceNom }}
                        </div>
                        <div class="skill-levels">
                            <span class="skill-level-badge employe">Emp: {{ getNiveauLabel(comp.niveauEmploye) }}</span>
                            <span class="skill-level-badge requis">Req: {{ getNiveauLabel(comp.niveauRequis) }}</span>
                        </div>
                    </div>
                    }
                </div>
            </div>

            @if (selectedCandidate()!.competencesManquantes.length > 0) {
            <div class="missing-skills">
                <h3>Compétences manquantes</h3>
                <div class="missing-list">
                    @for (s of selectedCandidate()!.competencesManquantes; track s) {
                    <span class="missing-chip">{{ s }}</span>
                    }
                </div>
            </div>
            }

            <button class="btn-affecter" [disabled]="!selectedCandidate()!.disponible"
                (click)="validerAffectation(selectedCandidate()!)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12" />
                </svg>
                Valider l'affectation
            </button>
        </div>
        } @else {
        <div class="select-hint">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
            </svg>
            <p>Sélectionnez un candidat pour voir le détail</p>
        </div>
        }
    </div>
    }
    }

    <!-- État initial -->
    @if (!matchingDone() && !loadingMatching()) {
    <div class="initial-state">
        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <circle cx="11" cy="11" r="8" />
            <line x1="21" y1="21" x2="16.65" y2="16.65" />
        </svg>
        <h3>Prêt pour le matching</h3>
        <p>Sélectionnez un projet et lancez l'analyse pour trouver les meilleurs profils</p>
    </div>
    }

</div>