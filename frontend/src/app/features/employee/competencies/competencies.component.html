<div class="competencies-container">
    <!-- Page Header -->
    <header class="page-header">
        <div class="header-content">
            <h1>Mes Compétences</h1>
            <p>Gérez et évaluez vos compétences techniques et professionnelles</p>
        </div>
        <button class="btn-primary" (click)="openEvaluationModal()">
            <span class="btn-icon">+</span>
            Ajouter / Évaluer
        </button>
    </header>

    <!-- KPI Dashboard -->
    <section class="stats-dashboard">
        <div class="stat-card total">
            <div class="stat-icon">STATS</div>
            <div class="stat-info">
                <h3>{{ stats().total }}</h3>
                <p>Total Déclarées</p>
            </div>
        </div>
        <div class="stat-card validated">
            <div class="stat-icon">✅</div>
            <div class="stat-info">
                <h3>{{ stats().validated }}</h3>
                <p>Validées par Manager</p>
            </div>
        </div>
        <div class="stat-card pending">
            <div class="stat-icon">⏳</div>
            <div class="stat-info">
                <h3>{{ stats().pending }}</h3>
                <p>En attente</p>
            </div>
        </div>
        <div class="stat-card average">
            <div class="stat-icon">⭐</div>
            <div class="stat-info">
                <h3>{{ stats().average }}/5</h3>
                <p>Niveau Moyen</p>
            </div>
        </div>
    </section>

    <!-- Toolbar: Search & Filters -->
    <div class="toolbar glass">
        <div class="search-box">
            <span class="search-icon">FIND</span>
            <input type="text" placeholder="Rechercher une compétence..." [ngModel]="searchTerm()"
                (ngModelChange)="searchTerm.set($event)">
        </div>

        <div class="filters">
            <select [ngModel]="selectedCategory()" (ngModelChange)="selectedCategory.set($event)">
                <option value="">Toutes les catégories</option>
                @for (cat of categories(); track cat) {
                <option [value]="cat">{{ cat }}</option>
                }
            </select>

            <select [ngModel]="selectedLevel()" (ngModelChange)="selectedLevel.set($event ? +$event : null)">
                <option value="">Tous les niveaux</option>
                <option value="1">1 - Débutant</option>
                <option value="2">2 - Notions</option>
                <option value="3">3 - Autonome</option>
                <option value="4">4 - Maîtrise</option>
                <option value="5">5 - Expert</option>
            </select>
        </div>
    </div>

    <!-- Messages d'erreur et de succès -->
    @if (errorMessage()) {
    <div class="alert alert-error animate-fade-in">
        <span>Error: {{ errorMessage() }}</span>
        <button (click)="errorMessage.set(null)">✕</button>
    </div>
    }
    @if (successMessage()) {
    <div class="alert alert-success animate-fade-in">
        <span>✅ {{ successMessage() }}</span>
    </div>
    }

    <!-- Main Content -->
    @if (loading()) {
    <div class="loading-state">
        <div class="spinner"></div>
        <p>Synchronisation de vos compétences...</p>
    </div>
    } @else {
    <div class="competencies-grid">
        @for (comp of filteredCompetencies(); track comp.id) {
        <div class="competence-card" (click)="openEvaluationModal(comp)">
            <div class="card-header">
                <div class="title-area">
                    <h3>{{ comp.competence.nom }}</h3>
                    <span class="category-badge">{{ comp.competence.type || comp.competence.categorie || 'Technique' }}</span>
                </div>
                <div class="status-indicator" [class.is-validated]="comp.niveauManager">
                    {{ comp.niveauManager ? 'Validée' : 'Auto-évaluée' }}
                </div>
            </div>

            <div class="levels-display">
                <div class="level-box auto">
                    <span class="label">Votre Niveau</span>
                    <div class="stars">
                        @for (star of [1,2,3,4,5]; track star) {
                        <span class="star" [class.filled]="star <= comp.niveauAuto">★</span>
                        }
                    </div>
                </div>

                <div class="level-box manager" [class.pending]="!comp.niveauManager">
                    <span class="label">Validation Manager</span>
                    @if (comp.niveauManager) {
                    <div class="stars">
                        @for (star of [1,2,3,4,5]; track star) {
                        <span class="star" [class.filled]="star <= comp.niveauManager!">★</span>
                        }
                    </div>
                    } @else {
                    <span class="pending-text">En attente de revue</span>
                    }
                </div>
            </div>

            <div class="card-footer">
                <span class="date">{{ comp.dateEvaluation | date:'shortDate' }}</span>
            </div>
        </div>
        } @empty {
        <div class="empty-state">
            <img src="/c:/Users/youco/.gemini/antigravity/brain/b5bb226c-36f7-46d1-992b-7e04ff4ac649/no_competencies_illustration_1770215389035.png"
                alt="Aucune compétence" class="empty-illustration">
            <h2>Prêt à briller ?</h2>
            <p>Vous n'avez pas encore ajouté de compétences. Commencez par déclarer vos talents pour booster votre
                profil.</p>
            <button class="btn-primary" (click)="openEvaluationModal()">
                Déclarer une compétence
            </button>
        </div>
        }
    </div>
    }

    <!-- Evaluation Modal -->
    @if (showModal()) {
    <div class="modal-overlay" (click)="closeModal()">
        <div class="modal-content glass" (click)="$event.stopPropagation()">
            <header class="modal-header">
                <h2>{{ isEditMode ? 'Mettre à jour' : 'Nouvelle compétence' }}</h2>
                <button class="btn-close" (click)="closeModal()">✕</button>
            </header>

            <div class="modal-body">
                <div class="form-group">
                    <label>Quelle est votre compétence ?</label>
                    <select [(ngModel)]="selectedCompetenceId" [disabled]="isEditMode">
                        <option value="">Sélectionner dans la liste...</option>
                        @for (c of allCompetencies(); track c.id) {
                        <option [value]="c.id">{{ c.nom }} ({{ c.categorie }})</option>
                        }
                    </select>
                </div>

                <div class="form-group">
                    <label>Comment vous évaluez-vous ?</label>
                    <div class="rating-input">
                        @for (star of [1,2,3,4,5]; track star) {
                        <span class="star-input" [class.active]="star <= evaluationForm.niveauAuto"
                            (click)="evaluationForm.niveauAuto = star">★</span>
                        }
                    </div>
                    <p class="rating-description">
                        Niveau {{ evaluationForm.niveauAuto }} :
                        <strong>{{ getNiveauLabel(evaluationForm.niveauAuto) }}</strong>
                    </p>
                </div>

                <div class="form-group">
                    <label>Contextualisez (Projets, Certifications...)</label>
                    <textarea [(ngModel)]="evaluationForm.commentaire" prev="4"
                        placeholder="Décrivez brièvement comment vous utilisez cette compétence..."></textarea>
                </div>
            </div>

            <footer class="modal-footer">
                <button class="btn-secondary" (click)="closeModal()">Annuler</button>
                <button class="btn-primary" (click)="submitEvaluation()" [disabled]="!selectedCompetenceId">
                    Enregistrer
                </button>
            </footer>
        </div>
    </div>
    }
</div>