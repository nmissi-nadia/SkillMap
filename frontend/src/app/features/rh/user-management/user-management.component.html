<div class="user-management-page">
    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <h1 class="title">
                Gestion des Utilisateurs
            </h1>
            <p class="subtitle">Administration des comptes et des rôles</p>
        </div>
        <div class="header-actions">
            <a routerLink="/rh/dashboard" class="back-btn">← Retour</a>
            <button class="create-btn" (click)="openCreateModal()">+ Nouvel Utilisateur</button>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-section">
        <div class="filter-group">
            <label>Filtrer par rôle</label>
            <div class="role-filters">
                <button class="role-filter-btn" [class.active]="selectedRole() === ''" (click)="clearFilter()">
                    Tous
                </button>
                @for (role of roles; track role) {
                <button class="role-filter-btn" [class.active]="selectedRole() === role"
                    [style.border-color]="getRoleColor(role)" (click)="filterByRole(role)">
                    {{ role }}
                </button>
                }
            </div>
        </div>

        <div class="search-group">
            <input type="text" placeholder="Rechercher par nom, prénom ou email..." [(ngModel)]="searchTerm"
                class="search-input" />
        </div>
    </div>

    <!-- Users Table -->
    @if (isLoading()) {
    <div class="loading-container">
        <div class="spinner"></div>
        <p>Chargement des utilisateurs...</p>
    </div>
    } @else {
    <div class="users-table-container">
        <table class="users-table">
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Email</th>
                    <th>Rôle</th>
                    <th>Provider</th>
                    <th>Statut</th>
                    <th>Date création</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @for (user of getFilteredUsers(); track user.id) {
                <tr>
                    <td class="user-name">
                        <div class="name-cell">
                            <span class="name">{{ user.prenom }} {{ user.nom }}</span>
                        </div>
                    </td>
                    <td>{{ user.email }}</td>
                    <td>
                        <span class="role-badge" [style.background-color]="getRoleColor(user.role)">
                            {{ user.role }}
                        </span>
                    </td>
                    <td>
                        <span class="provider-badge">{{ user.provider }}</span>
                    </td>
                    <td>
                        <span class="status-badge" [class.active]="user.enabled" [class.inactive]="!user.enabled">
                            {{ user.enabled ? 'Actif' : 'Inactif' }}
                        </span>
                    </td>
                    <td>{{ user.dateCreation | date:'dd/MM/yyyy' }}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-edit" (click)="openEditModal(user)" title="Modifier">
                                Edit
                            </button>
                            <button class="btn-toggle" (click)="toggleUserStatus(user)"
                                [title]="user.enabled ? 'Désactiver' : 'Activer'">
                                {{ user.enabled ? 'Lock' : 'Unlock' }}
                            </button>
                        </div>
                    </td>
                </tr>
                } @empty {
                <tr>
                    <td colspan="7" class="empty-state">
                        Aucun utilisateur trouvé
                    </td>
                </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="pagination">
        <button class="page-btn" (click)="previousPage()" [disabled]="currentPage() === 0">
            ← Précédent
        </button>
        <span class="page-info">
            Page {{ currentPage() + 1 }} - {{ totalElements() }} utilisateur(s)
        </span>
        <button class="page-btn" (click)="nextPage()" [disabled]="(currentPage() + 1) * pageSize() >= totalElements()">
            Suivant →
        </button>
    </div>
    }

    <!-- Create Modal -->
    @if (showCreateModal()) {
    <div class="modal-overlay" (click)="closeCreateModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h2>Créer un Utilisateur</h2>
                <button class="close-btn" (click)="closeCreateModal()">X</button>
            </div>
            <div class="modal-body">
                <form (ngSubmit)="createUser()">
                    <div class="form-group">
                        <label for="create-prenom">Prénom</label>
                        <input type="text" id="create-prenom" [(ngModel)]="newUser().prenom" name="prenom" required />
                    </div>

                    <div class="form-group">
                        <label for="create-nom">Nom</label>
                        <input type="text" id="create-nom" [(ngModel)]="newUser().nom" name="nom" required />
                    </div>

                    <div class="form-group">
                        <label for="create-email">Email</label>
                        <input type="email" id="create-email" [(ngModel)]="newUser().email" name="email" required />
                    </div>

                    <div class="form-group">
                        <label for="create-password">Mot de passe</label>
                        <input type="password" id="create-password" [(ngModel)]="newUser().password" name="password"
                            required />
                    </div>

                    <div class="form-group">
                        <label for="create-role">Rôle</label>
                        <select id="create-role" [(ngModel)]="newUser().role" name="role" required>
                            @for (role of roles; track role) {
                            <option [value]="role">{{ role }}</option>
                            }
                        </select>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn-cancel" (click)="closeCreateModal()">
                            Annuler
                        </button>
                        <button type="submit" class="btn-submit">
                            Créer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    }

    <!-- Edit Modal -->
    @if (showEditModal() && selectedUser()) {
    <div class="modal-overlay" (click)="closeEditModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h2>Modifier l'Utilisateur</h2>
                <button class="close-btn" (click)="closeEditModal()">X</button>
            </div>
            <div class="modal-body">
                <form (ngSubmit)="updateUser()">
                    <div class="form-group">
                        <label for="edit-prenom">Prénom</label>
                        <input type="text" id="edit-prenom" [(ngModel)]="editUser().prenom" name="prenom" />
                    </div>

                    <div class="form-group">
                        <label for="edit-nom">Nom</label>
                        <input type="text" id="edit-nom" [(ngModel)]="editUser().nom" name="nom" />
                    </div>

                    <div class="form-group">
                        <label for="edit-email">Email</label>
                        <input type="email" id="edit-email" [(ngModel)]="editUser().email" name="email" />
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn-cancel" (click)="closeEditModal()">
                            Annuler
                        </button>
                        <button type="submit" class="btn-submit">
                            Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    }
</div>