<div class="evaluations-container">
    <div class="page-header">
        <div class="header-content">
            <h1>Évaluations en Attente</h1>
            <p>Validez ou ajustez les auto-évaluations de votre équipe</p>
        </div>
    </div>

    @if (errorMessage()) {
    <div class="alert alert-error">
        <span>! {{ errorMessage() }}</span>
        <button (click)="errorMessage.set(null)">X</button>
    </div>
    }

    @if (successMessage()) {
    <div class="alert alert-success">
        <span>OK {{ successMessage() }}</span>
        <button (click)="successMessage.set(null)">X</button>
    </div>
    }

    @if (loading()) {
    <div class="loading-state">
        <div class="spinner"></div>
        <p>Chargement des évaluations...</p>
    </div>
    } @else {
    @if (evaluations().length === 0) {
    <div class="empty-state">
        <p>Aucune évaluation en attente</p>
        <small>Toutes les auto-évaluations ont été traitées</small>
    </div>
    } @else {
    <div class="evaluations-grid">
        @for (eval of evaluations(); track eval.id) {
        <div class="evaluation-card">
            <div class="card-header">
                <div class="employee-info">
                    <div class="employee-avatar">
                        {{ eval.employe.prenom.charAt(0) }}{{ eval.employe.nom.charAt(0) }}
                    </div>
                    <div>
                        <div class="employee-name">{{ eval.employe.prenom }} {{ eval.employe.nom }}</div>
                        <div class="competence-name">{{ eval.competence.nom }}</div>
                    </div>
                </div>
                <div class="date-badge">
                    {{ eval.dateAutoEvaluation | date:'dd/MM/yyyy' }}
                </div>
            </div>

            <div class="card-body">
                <div class="niveau-section">
                    <label>Auto-évaluation:</label>
                    <div class="stars">
                        @for (star of getStars(eval.niveauAuto); track $index) {
                        <span [class.filled]="star === '★'">{{ star }}</span>
                        }
                        <span class="niveau-label">{{ getNiveauLabel(eval.niveauAuto) }}</span>
                    </div>
                </div>

                @if (eval.commentaireEmploye) {
                <div class="commentaire-section">
                    <label>Commentaire:</label>
                    <p class="commentaire">{{ eval.commentaireEmploye }}</p>
                </div>
                }
            </div>

            <div class="card-footer">
                <button class="btn-primary" (click)="openValidationModal(eval)">
                    Évaluer
                </button>
            </div>
        </div>
        }
    </div>
    }
    }
</div>

<!-- Modal de validation -->
@if (showModal() && selectedEvaluation()) {
<div class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>Valider l'évaluation</h2>
            <button class="btn-close" (click)="closeModal()">X</button>
        </div>

        <div class="modal-body">
            <div class="employee-section">
                <strong>{{ selectedEvaluation()!.employe.prenom }} {{ selectedEvaluation()!.employe.nom }}</strong>
                <span class="separator">•</span>
                <span>{{ selectedEvaluation()!.competence.nom }}</span>
            </div>

            <div class="auto-eval-section">
                <label>Auto-évaluation de l'employé:</label>
                <div class="stars large">
                    @for (star of getStars(selectedEvaluation()!.niveauAuto); track $index) {
                    <span [class.filled]="star === '★'">{{ star }}</span>
                    }
                    <span class="niveau-label">{{ getNiveauLabel(selectedEvaluation()!.niveauAuto) }}</span>
                </div>
                @if (selectedEvaluation()!.commentaireEmploye) {
                <p class="commentaire">{{ selectedEvaluation()!.commentaireEmploye }}</p>
                }
            </div>

            <div class="form-group">
                <label>Votre évaluation (Manager):</label>
                <div class="rating-input">
                    @for (i of [1, 2, 3, 4, 5]; track i) {
                    <span class="star-input" [class.active]="i <= niveauManager()" (click)="niveauManager.set(i)">
                        {{ i <= niveauManager() ? '★' : '☆' }} </span>
                            }
                </div>
                <p class="rating-label">{{ getNiveauLabel(niveauManager()) }}</p>
            </div>

            <div class="form-group">
                <label>Commentaire (optionnel):</label>
                <textarea [value]="commentaireManager()" (input)="commentaireManager.set($any($event.target).value)"
                    placeholder="Ajoutez vos remarques et recommandations..." rows="4"></textarea>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-secondary" (click)="closeModal()">Annuler</button>
            <button class="btn-primary" (click)="validateEvaluation(true)" [disabled]="niveauManager() === 0">
                Valider
            </button>
        </div>
    </div>
</div>
}